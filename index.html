<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wedding Guest Clipboard Helper</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen">
  <div class="max-w-5xl mx-auto p-4 sm:p-6">
    <header class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3 mb-6">
      <div>
        <h1 class="text-2xl font-semibold">Guest List Clipboard Helper</h1>
        <p class="text-sm text-gray-600">Auto-loads <code>guest_rows.csv</code>. One-click copy for invitation links & WhatsApp messages.</p>
      </div>
      <div class="flex items-center gap-2">
        <input id="searchInput" type="search" placeholder="Search name, ID, relationâ€¦" class="w-64 max-w-full px-3 py-2 border rounded-xl bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-gray-300" />
        <span id="countChip" class="text-xs px-2 py-0.5 rounded-full bg-gray-100">0 guests</span>
      </div>
    </header>

    <section class="mb-4">
      <div class="bg-white border rounded-2xl p-4 shadow-sm text-sm text-gray-700">
        <div class="flex flex-wrap gap-x-6 gap-y-2">
          <div>Base URL: <code id="cfgBaseUrl"></code></div>
          <div>Due date: <code id="cfgDue"></code></div>
          <div>CSV file: <code>guest_rows.csv</code></div>
        </div>
        <p class="text-xs text-gray-500 mt-1">Update the list by committing a new <code>guest_rows.csv</code>.</p>
      </div>
    </section>

    <section>
      <div class="bg-white border rounded-2xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-gray-100">
              <tr class="text-left">
                <th class="px-3 py-2 font-medium">ID</th>
                <th class="px-3 py-2 font-medium">Name</th>
                <th class="px-3 py-2 font-medium">Type</th>
                <th class="px-3 py-2 font-medium">Relation</th>
                <th class="px-3 py-2 font-medium">Link</th>
                <th class="px-3 py-2 font-medium">Actions</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="fixed left-1/2 -translate-x-1/2 bottom-4 px-3 py-2 rounded-xl bg-black/80 text-white text-sm shadow-lg opacity-0 pointer-events-none transition">Copied!</div>

  <script>
    const BASE_URL = 'https://www.alfoncindy.site';
    const DUE = '7th September 2025';
    const CSV_PATH = 'guest_rows.csv';

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('cfgBaseUrl').textContent = BASE_URL;
      document.getElementById('cfgDue').textContent = DUE;
    });

    const INVITE_TYPE_MAP = {
      reception: 'Reception',
      holy_matrimony: 'Holy Matrimony'
    };

    const RELATION_MAP = {
      cindy_parent_relation: "Cindy's Parent",
      alfon_parent_relation: "Alfon's Parent",
      cindy_relation: "Cindy",
      alfon_relation: "Alfon"
    };

    const $ = (sel) => document.querySelector(sel);
    const tbody = $('#tbody');
    const searchInput = $('#searchInput');
    const countChip = $('#countChip');

    function formatValue(val, map) {
      const key = String(val || '').toLowerCase();
      if (map[key]) return map[key];
      return String(val || '').replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function buildLink(g) {
      return `${BASE_URL}/${encodeURIComponent(g.id)}`;
    }

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.remove('opacity-0');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => el.classList.add('opacity-0'), 1400);
    }

    function renderRows(list) {
      tbody.innerHTML = '';
      list.forEach((g) => {
        const link = buildLink(g);
        const tr = document.createElement('tr');
        tr.className = 'border-t';
        const typeDisplay = formatValue(g.invitation_type, INVITE_TYPE_MAP);
        const relDisplay = formatValue(g.relation, RELATION_MAP);
        tr.innerHTML = `
          <td class="px-3 py-2">${g.id}</td>
          <td class="px-3 py-2">${g.name}</td>
          <td class="px-3 py-2">${typeDisplay}</td>
          <td class="px-3 py-2">${relDisplay}</td>
          <td class="px-3 py-2"><a href="${link}" target="_blank" class="text-blue-600 underline break-all">${link}</a></td>
          <td class="px-3 py-2 space-x-1">
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm px-3 py-1.5 rounded-lg shadow active:scale-95 transition" onclick="navigator.clipboard.writeText('${link}').then(()=>showToast('Link copied'))">Copy Link</button>
            <button class="bg-blue-600 hover:bg-blue-700 text-white font-medium text-sm px-3 py-1.5 rounded-lg shadow active:scale-95 transition" onclick="navigator.clipboard.writeText(buildMessage(g)).then(()=>showToast('Message copied'))">Copy WA</button>
            <a class="bg-green-600 hover:bg-green-700 text-white font-medium text-sm px-3 py-1.5 rounded-lg shadow active:scale-95 transition inline-block" href="https://wa.me/?text=${encodeURIComponent(buildMessage(g))}" target="_blank">Open WhatsApp</a>
          </td>`;
        tbody.appendChild(tr);
      });
      countChip.textContent = `${list.length} guest${list.length !== 1 ? 's' : ''}`;
    }

    function buildMessage(g) {
      // Simple message for demo; integrate your previous template logic if needed.
      return `Hi ${g.name}, please check your invitation: ${BASE_URL}/${g.id}`;
    }

    function applySearch(all) {
      const q = searchInput.value.trim().toLowerCase();
      const filtered = !q ? all : all.filter(g =>
        String(g.id).toLowerCase().includes(q) ||
        String(g.name).toLowerCase().includes(q) ||
        String(g.invitation_type).toLowerCase().includes(q) ||
        String(g.relation).toLowerCase().includes(q)
      );
      renderRows(filtered);
    }

    let ALL = [];
    fetch(`${CSV_PATH}?v=${Date.now()}`, { cache: 'no-cache' })
      .then(res => res.text())
      .then(text => {
        const parsed = Papa.parse(text, { header: true, skipEmptyLines: true });
        ALL = parsed.data.map(r => ({
          id: r.id,
          name: r.name,
          invitation_type: r.invitation_type,
          relation: r.relation
        })).filter(r => r.id && r.name);
        applySearch(ALL);
      });

    searchInput.addEventListener('input', () => applySearch(ALL));
  </script>
</body>
</html>
